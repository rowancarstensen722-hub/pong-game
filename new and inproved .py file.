import pygame
import sys
import random

pygame.init()

info = pygame.display.Info()
WIDTH, HEIGHT = info.current_w, info.current_h
screen = pygame.display.set_mode((WIDTH, HEIGHT), pygame.FULLSCREEN)
pygame.display.set_caption("Minecraft Pong 3D")
clock = pygame.time.Clock()

GRASS = (95, 159, 53)
STONE = (120, 120, 120)
WHITE = (255, 255, 255)
SHADOW = (50, 50, 50)
font = pygame.font.Font(None, 74)

def draw_3d_block(rect, color):
    shadow = pygame.Rect(rect.x + 5, rect.y + 5, rect.width, rect.height)
    pygame.draw.rect(screen, SHADOW, shadow)
    pygame.draw.rect(screen, color, rect)
    pygame.draw.rect(screen, STONE, rect, 3)

def show_menu():
    screen.fill(GRASS)
    screen.blit(font.render("1 = Single Player", True, WHITE), (WIDTH//2 - 250, HEIGHT//2 - 100))
    screen.blit(font.render("2 = Two Player", True, WHITE), (WIDTH//2 - 250, HEIGHT//2))
    pygame.display.flip()

def show_difficulty():
    screen.fill(GRASS)
    screen.blit(font.render("E = Easy", True, WHITE), (WIDTH//2 - 150, HEIGHT//2 - 100))
    screen.blit(font.render("M = Medium", True, WHITE), (WIDTH//2 - 150, HEIGHT//2))
    screen.blit(font.render("H = Hard", True, WHITE), (WIDTH//2 - 150, HEIGHT//2 + 100))
    pygame.display.flip()

def show_winner(winner):
    screen.fill(GRASS)
    text = font.render(f"{winner} Wins!", True, WHITE)
    screen.blit(text, (WIDTH // 2 - text.get_width() // 2, HEIGHT // 2 - 50))
    pygame.display.flip()
    pygame.time.delay(3000)

def get_ball_speed(direction, base=5):
    return [base * direction, random.choice([-base, base])]

def predict_ball_y(ball, speed, paddle_x):
    frames = abs((paddle_x - ball.x) / speed[0])
    predicted_y = ball.y + speed[1] * frames
    while predicted_y < 0 or predicted_y > HEIGHT:
        if predicted_y < 0:
            predicted_y = -predicted_y
        elif predicted_y > HEIGHT:
            predicted_y = 2 * HEIGHT - predicted_y
    return predicted_y

def reset_game():
    mode = None
    difficulty = None
    ai_speed = 5

    while mode is None:
        show_menu()
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_1:
                    mode = 1
                elif event.key == pygame.K_2:
                    mode = 2

    if mode == 1:
        while difficulty is None:
            show_difficulty()
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    pygame.quit()
                    sys.exit()
                if event.type == pygame.KEYDOWN:
                    if event.key == pygame.K_e:
                        ai_speed = 3
                        difficulty = "easy"
                    elif event.key == pygame.K_m:
                        ai_speed = 5
                        difficulty = "medium"
                    elif event.key == pygame.K_h:
                        ai_speed = 8
                        difficulty = "hard"

    ball = pygame.Rect(WIDTH // 2, HEIGHT // 2, 30, 30)
    paddle1 = pygame.Rect(50, HEIGHT // 2 - 60, 20, 120)
    paddle2 = pygame.Rect(WIDTH - 70, HEIGHT // 2 - 60, 20, 120)
    ball_speed = get_ball_speed(random.choice([-1, 1]))
    score1 = 0
    score2 = 0
    spike_ready = True

    return mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2, spike_ready

mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2, spike_ready = reset_game()

while True:
    screen.fill(GRASS)

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_r:
                mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2, spike_ready = reset_game()
            if event.key == pygame.K_ESCAPE:
                pygame.quit()
                sys.exit()
            if event.key == pygame.K_LSHIFT and spike_ready:
                ball_speed[0] *= 3
                ball_speed[1] *= 3
                spike_ready = False  # prevent stacking

    # Ball movement
    ball.x += ball_speed[0]
    ball.y += ball_speed[1]

    if ball.top <= 0 or ball.bottom >= HEIGHT:
        ball_speed[1] *= -1

    if ball.colliderect(paddle1) or ball.colliderect(paddle2):
        ball_speed[0] *= -1
        spike_ready = True  # reset spike after paddle hit

    if ball.left < 0:
        score2 += 1
        ball.center = (WIDTH - 100, HEIGHT // 2)
        ball_speed = get_ball_speed(-1)
        spike_ready = True
    if ball.right > WIDTH:
        score1 += 1
        ball.center = (100, HEIGHT // 2)
        ball_speed = get_ball_speed(1)
        spike_ready = True

    # Win condition
    if score1 >= 20:
        show_winner("Player 1")
        mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2, spike_ready = reset_game()
        continue
    elif score2 >= 20:
        winner = "Player 2" if mode == 2 else "Computer"
        show_winner(winner)
        mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2, spike_ready = reset_game()
        continue

    # Paddle movement
    keys = pygame.key.get_pressed()
    if keys[pygame.K_w] and paddle1.top > 0:
        paddle1.y -= 6
    if keys[pygame.K_s] and paddle1.bottom < HEIGHT:
        paddle1.y += 6

    if mode == 2:
        if keys[pygame.K_UP] and paddle2.top > 0:
            paddle2.y -= 6
        if keys[pygame.K_DOWN] and paddle2.bottom < HEIGHT:
            paddle2.y += 6
    else:
        target_y = predict_ball_y(ball, ball_speed, paddle2.x)
        if paddle2.centery < target_y and paddle2.bottom < HEIGHT:
            paddle2.y += ai_speed
        elif paddle2.centery > target_y and paddle2.top > 0:
            paddle2.y -= ai_speed

    draw_3d_block(paddle1, WHITE)
    draw_3d_block(paddle2, WHITE)
    draw_3d_block(ball, WHITE)
    pygame.draw.aaline(screen, STONE, (WIDTH // 2, 0), (WIDTH // 2, HEIGHT))

    screen.blit(font.render(str(score1), True, WHITE), (WIDTH // 4, 20))
    screen.blit(font.render(str(score2), True, WHITE), (WIDTH * 3 // 4, 20))

    pygame.display.flip()
    clock.tick(60)

def predict_ball_y(ball, speed, paddle_x):
    frames = abs((paddle_x - ball.x) / speed[0])
    predicted_y = ball.y + speed[1] * frames
    while predicted_y < 0 or predicted_y > HEIGHT:
        if predicted_y < 0:
            predicted_y = -predicted_y
        elif predicted_y > HEIGHT:
            predicted_y = 2 * HEIGHT - predicted_y
    return predicted_y

def reset_game():
    mode = None
    difficulty = None
    ai_speed = 5

    while mode is None:
        show_menu()
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                pygame.quit()
                sys.exit()
            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_1:
                    mode = 1
                elif event.key == pygame.K_2:
                    mode = 2

    if mode == 1:
        while difficulty is None:
            show_difficulty()
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    pygame.quit()
                    sys.exit()
                if event.type == pygame.KEYDOWN:
                    if event.key == pygame.K_e:
                        ai_speed = 3
                        difficulty = "easy"
                    elif event.key == pygame.K_m:
                        ai_speed = 5
                        difficulty = "medium"
                    elif event.key == pygame.K_h:
                        ai_speed = 8
                        difficulty = "hard"

    ball = pygame.Rect(WIDTH // 2, HEIGHT // 2, 30, 30)
    paddle1 = pygame.Rect(50, HEIGHT // 2 - 60, 20, 120)
    paddle2 = pygame.Rect(WIDTH - 70, HEIGHT // 2 - 60, 20, 120)
    ball_speed = get_ball_speed(random.choice([-1, 1]))
    score1 = 0
    score2 = 0

    return mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2

# Start game
mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2 = reset_game()

while True:
    screen.fill(GRASS)

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_r:
                mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2 = reset_game()
            if event.key == pygame.K_ESCAPE:
                pygame.quit()
                sys.exit()

    # Ball movement
    ball.x += ball_speed[0]
    ball.y += ball_speed[1]

    if ball.top <= 0 or ball.bottom >= HEIGHT:
        ball_speed[1] *= -1

    if ball.colliderect(paddle1) or ball.colliderect(paddle2):
        ball_speed[0] *= -1

    if ball.left < 0:
        score2 += 1
        ball.center = (WIDTH - 100, HEIGHT // 2)
        ball_speed = get_ball_speed(-1)
    if ball.right > WIDTH:
        score1 += 1
        ball.center = (100, HEIGHT // 2)
        ball_speed = get_ball_speed(1)

    # Win condition
    if score1 >= 20:
        show_winner("Player 1")
        mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2 = reset_game()
        continue
    elif score2 >= 20:
        winner = "Player 2" if mode == 2 else "Computer"
        show_winner(winner)
        mode, difficulty, ai_speed, ball, paddle1, paddle2, ball_speed, score1, score2 = reset_game()
        continue

    # Paddle movement
    keys = pygame.key.get_pressed()
    if keys[pygame.K_w] and paddle1.top > 0:
        paddle1.y -= 6
    if keys[pygame.K_s] and paddle1.bottom < HEIGHT:
        paddle1.y += 6

    if mode == 2:
        if keys[pygame.K_UP] and paddle2.top > 0:
            paddle2.y -= 6
        if keys[pygame.K_DOWN] and paddle2.bottom < HEIGHT:
            paddle2.y += 6
    else:
        target_y = predict_ball_y(ball, ball_speed, paddle2.x)
        if paddle2.centery < target_y and paddle2.bottom < HEIGHT:
            paddle2.y += ai_speed
        elif paddle2.centery > target_y and paddle2.top > 0:
            paddle2.y -= ai_speed

    # Draw everything
    draw_3d_block(paddle1, WHITE)
    draw_3d_block(paddle2, WHITE)
    draw_3d_block(ball, WHITE)
    pygame.draw.aaline(screen, STONE, (WIDTH // 2, 0), (WIDTH // 2, HEIGHT))

    screen.blit(font.render(str(score1), True, WHITE), (WIDTH // 4, 20))
    screen.blit(font.render(str(score2), True, WHITE), (WIDTH * 3 // 4, 20))

    pygame.display.flip()
    clock.tick(60)
